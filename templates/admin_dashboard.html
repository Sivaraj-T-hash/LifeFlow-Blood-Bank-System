{% extends 'layout.html' %}
{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<style>
    /* Admin Dark Theme Background */
    body { 
        background: linear-gradient(135deg, #2b0404, #4a0e0e, #801f1f) !important; 
        color: white !important; 
        min-height: 100vh;
    }
    .glass-card { 
        background: rgba(255, 255, 255, 0.08); 
        backdrop-filter: blur(10px); 
        border: 1px solid rgba(255, 255, 255, 0.2); 
        border-radius: 12px; 
        color: white; 
    }
    .form-control, .form-select { 
        background-color: rgba(0, 0, 0, 0.5) !important; 
        border: 1px solid rgba(255, 255, 255, 0.3) !important; 
        color: white !important; 
    }
    option { background-color: #222; color: white; }
    .nav-tabs .nav-link { color: rgba(255,255,255,0.7); cursor: pointer; font-weight: bold; }
    .nav-tabs .nav-link.active { 
        background-color: rgba(255,255,255,0.15) !important; 
        color: #ffc107 !important; 
        border-color: transparent; 
    }
    h3, h4 { color: white !important; text-shadow: 0px 2px 4px rgba(0,0,0,0.5); }
    p, .small, small { color: #e0e0e0 !important; opacity: 1 !important; }
    label.form-label { color: #ffc107 !important; font-weight: bold; }
    
    /* Terminal Font for Audit Log */
    .audit-font { font-family: 'Courier New', Courier, monospace; letter-spacing: 0.5px; }
</style>

<div class="glass-card p-4 mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="text-white fw-bold">Admin Dashboard</h3>
        <div>
            <button class="btn btn-outline-warning btn-sm me-2 fw-bold" data-bs-toggle="modal" data-bs-target="#adminProfileModal">
                <i class="bi bi-gear-fill"></i> Edit Profile
            </button>
            <span class="badge bg-warning text-dark">Super Admin</span>
        </div>
    </div>

    <ul class="nav nav-tabs border-0 mb-4" id="adminTabs" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#users">üë§ Manage Users</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#hosts">üèïÔ∏è Manage Camp Hosts</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#hospitals">üè• Manage Hospitals</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#pending">‚è≥ Pending Requests</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#verified">‚úÖ Verified History</button></li>
        <li class="nav-item"><button class="nav-link text-danger fw-bolder" data-bs-toggle="tab" data-bs-target="#audit">üõ°Ô∏è Security Audit Log</button></li>
        <li class="nav-item"><button class="nav-link text-info fw-bolder" data-bs-toggle="tab" data-bs-target="#ai_analytics">üß† AI Predictive Analytics</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#reports">üìä Reports & Export</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#gallery">üñºÔ∏è Gallery</button></li>
    </ul>

    <div class="tab-content">
        
        <div class="tab-pane fade show active" id="users">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="text-light">Registered Donors</h4>
                <div class="btn-group">
                    <a href="{{ url_for('add_user') }}" class="btn btn-sm btn-warning fw-bold me-2">+ Add New User</a>
                    <a href="{{ url_for('export_report', type='users_list', file_format='csv') }}" class="btn btn-sm btn-outline-success">Download CSV</a>
                    <a href="{{ url_for('export_report', type='users_list', file_format='pdf') }}" class="btn btn-sm btn-outline-danger">Download PDF</a>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-dark table-hover align-middle">
                    <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Group</th><th>City</th><th>Actions</th></tr></thead>
                    <tbody>
                        {% for donor in donors %}
                        <tr>
                            <td>{{ donor['name'] }}</td><td>{{ donor['email'] }}</td><td>{{ donor['phone'] }}</td>
                            <td><span class="badge bg-danger">{{ donor['blood_group'] }}</span></td><td>{{ donor['city'] }}</td>
                            <td>
                                <button class="btn btn-sm btn-success fw-bold me-1" data-bs-toggle="modal" data-bs-target="#adminAddUnitsModal" onclick="document.getElementById('add_user_id').value='{{ donor.id }}'; document.getElementById('add_user_name').innerText='{{ donor.name }}';">
                                    + Add Units
                                </button>
                                <a href="{{ url_for('edit_user', id=donor['id']) }}" class="btn btn-sm btn-outline-light">Edit</a>
                                <a href="{{ url_for('delete_user', id=donor['id']) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete?');">Delete</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-pane fade" id="hosts">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="text-info">Camp Organizers & Hosts</h4>
                <div class="btn-group">
                    <a href="{{ url_for('add_host') }}" class="btn btn-sm btn-info fw-bold text-dark me-2">+ Add New Host</a>
                    <a href="{{ url_for('export_report', type='hosts_list', file_format='csv') }}" class="btn btn-sm btn-outline-success">Download CSV</a>
                    <a href="{{ url_for('export_report', type='hosts_list', file_format='pdf') }}" class="btn btn-sm btn-outline-danger">Download PDF</a>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-dark table-hover align-middle">
                    <thead><tr><th>Organization</th><th>Leader Name</th><th>Contact</th><th>Aadhar</th><th>City</th><th>Actions</th></tr></thead>
                    <tbody>
                        {% for host in hosts %}
                        <tr>
                            <td class="fw-bold">{{ host['organization_name'] }}</td><td>{{ host['leader_name'] }}</td>
                            <td><small>{{ host['email'] }}</small><br><small class="text-warning">{{ host['phone'] }}</small></td>
                            <td>{{ host['aadhar_number'] }}</td><td>{{ host['city'] }}</td>
                            <td>
                                <a href="{{ url_for('edit_host', id=host['id']) }}" class="btn btn-sm btn-outline-warning">Edit</a>
                                <a href="{{ url_for('delete_host', id=host['id']) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete?');">Delete</a>
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="6" class="text-center text-white-50">No hosts found.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-pane fade" id="hospitals">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="text-warning">Hospital Management</h4>
                <div class="btn-group">
                    <a href="{{ url_for('add_hospital') }}" class="btn btn-sm btn-warning fw-bold me-2">+ Add New Hospital</a>
                    <a href="{{ url_for('export_report', type='hospitals_list', file_format='csv') }}" class="btn btn-sm btn-outline-success">Download CSV</a>
                    <a href="{{ url_for('export_report', type='hospitals_list', file_format='pdf') }}" class="btn btn-sm btn-outline-danger">Download PDF</a>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-dark table-hover align-middle">
                    <thead><tr><th>Name</th><th>Email</th><th>Type</th><th>Location</th><th>Actions</th></tr></thead>
                    <tbody>
                        {% for h in hospitals %}
                        <tr>
                            <td class="fw-bold">{{ h.name }}</td><td>{{ h.email }}</td>
                            <td><span class="badge bg-info text-dark">{{ h.type }}</span></td>
                            <td><small>Lat: {{ h.lat }}<br>Lng: {{ h.lng }}</small></td>
                            <td>
                                <a href="{{ url_for('edit_hospital', id=h.id) }}" class="btn btn-sm btn-outline-warning">Edit</a>
                                <a href="{{ url_for('delete_hospital', id=h.id) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete?');">Delete</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-pane fade" id="pending">
             <h4 class="text-warning mb-3">‚è≥ Pending Verification</h4>
             <div class="table-responsive">
                 <table class="table table-dark table-hover align-middle">
                     <thead><tr><th>Date</th><th>Hospital</th><th>Donor</th><th>Phone</th><th>Status</th></tr></thead>
                     <tbody>
                         {% for appt in pending_appts %}
                         <tr>
                             <td>{{ appt['date'] }}</td><td class="text-info fw-bold">{{ appt['hospital_name'] }}</td>
                             <td>{{ appt['donor'] }}</td><td>{{ appt['phone'] }}</td>
                             <td><span class="badge bg-warning text-dark">Pending</span></td>
                         </tr>
                         {% else %}<tr><td colspan="5" class="text-center">No pending appointments.</td></tr>{% endfor %}
                     </tbody>
                 </table>
             </div>
        </div>

        <div class="tab-pane fade" id="verified">
             <h4 class="text-success mb-3">‚úÖ Verified Donations</h4>
             <div class="table-responsive">
                 <table class="table table-dark table-hover align-middle">
                     <thead><tr><th>Date</th><th>Hospital</th><th>Donor</th><th>Phone</th><th>Status</th></tr></thead>
                     <tbody>
                         {% for appt in verified_appts %}
                         <tr>
                             <td>{{ appt['date'] }}</td><td class="text-info fw-bold">{{ appt['hospital_name'] }}</td>
                             <td>{{ appt['donor'] }}</td><td>{{ appt['phone'] }}</td>
                             <td><span class="badge bg-success">Verified</span></td>
                         </tr>
                         {% else %}<tr><td colspan="5" class="text-center">No verified donations.</td></tr>{% endfor %}
                     </tbody>
                 </table>
             </div>
        </div>

        <div class="tab-pane fade" id="audit">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="text-danger fw-bold"><i class="bi bi-shield-lock-fill me-2"></i> Database Trigger Audit Log</h4>
                <span class="badge bg-danger shadow-sm py-2 px-3 fw-bold" style="letter-spacing: 1px;"><i class="bi bi-record-circle me-1"></i> LIVE MONITORING</span>
            </div>
            
            <div class="alert alert-dark border-danger text-light mb-4" style="background-color: rgba(220, 53, 69, 0.1);">
                <i class="bi bi-info-circle-fill text-danger me-2"></i>
                <strong>DBMS Architecture Note:</strong> These logs are generated automatically by <b>SQL Triggers</b> on the backend. They operate independently of the Python code, ensuring a tamper-proof record of all critical state changes (Approvals/Rejections).
            </div>

            <div class="table-responsive bg-dark p-2 rounded border border-secondary shadow-lg">
                <table class="table table-dark table-hover align-middle audit-font mb-0">
                    <thead style="border-bottom: 2px solid #dc3545;">
                        <tr>
                            <th class="text-secondary">#LOG_ID</th>
                            <th class="text-warning">TIMESTAMP</th>
                            <th>TARGET_TABLE</th>
                            <th>ACTION</th>
                            <th>RECORD_ID</th>
                            <th>OLD_STATE</th>
                            <th>NEW_STATE</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in audit_logs %}
                        <tr>
                            <td class="text-secondary">{{ log['log_id'] }}</td>
                            <td class="text-warning">{{ log['action_timestamp'] }}</td>
                            <td><span class="badge bg-secondary">{{ log['table_name'] | upper }}</span></td>
                            <td><span class="text-info fw-bold">[{{ log['action_type'] }}]</span></td>
                            <td>ID: {{ log['record_id'] }}</td>
                            <td><span class="text-light opacity-50">{{ log['old_status'] }}</span></td>
                            <td>
                                {% if log['new_status'] == 'Verified' or log['new_status'] == 'Approved' %}
                                    <span class="text-success fw-bold">‚ñ∫ {{ log['new_status'] }}</span>
                                {% elif log['new_status'] == 'Rejected' %}
                                    <span class="text-danger fw-bold">‚ñ∫ {{ log['new_status'] }}</span>
                                {% else %}
                                    <span class="text-primary fw-bold">‚ñ∫ {{ log['new_status'] }}</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="text-center text-muted py-4">
                                <i class="bi bi-shield-check fs-1 d-block mb-2"></i>
                                System secure. No status changes have been triggered yet.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-pane fade" id="ai_analytics">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="text-info fw-bold"><i class="bi bi-robot me-2"></i> Shortage Prediction Engine</h4>
                <span class="badge bg-info text-dark shadow-sm py-2 px-3 fw-bold" style="letter-spacing: 1px;">SQL WINDOW FUNCTIONS</span>
            </div>
            
            <div class="alert alert-dark border-info text-light mb-4" style="background-color: rgba(13, 202, 240, 0.1);">
                <i class="bi bi-cpu text-info me-2 fs-5"></i>
                <strong>Algorithm Note:</strong> This panel uses advanced <code>OVER (PARTITION BY)</code> Window Functions. It dynamically calculates the global average of blood collections across all servers, comparing individual hospitals in real-time to detect statistical anomalies indicating a severe shortage.
            </div>

            <div class="table-responsive bg-dark p-2 rounded border border-secondary shadow-lg">
                <table class="table table-dark table-hover align-middle mb-0">
                    <thead style="border-bottom: 2px solid #0dcaf0;">
                        <tr>
                            <th class="text-light">HOSPITAL NAME</th>
                            <th class="text-center text-info">CURRENT STOCK (UNITS)</th>
                            <th class="text-center text-secondary">GLOBAL MOVING AVG</th>
                            <th class="text-end">AI PREDICTION STATUS</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ai in ai_predictions %}
                        <tr>
                            <td class="fw-bold">{{ ai.hospital }}</td>
                            <td class="text-center fs-5">{{ ai.current_stock }}</td>
                            <td class="text-center text-secondary fst-italic">{{ ai.global_avg }}</td>
                            <td class="text-end">
                                {% if 'CRITICAL' in ai.ai_status %}
                                    <span class="badge bg-danger px-3 py-2 fs-6 heartbeat shadow-sm">{{ ai.ai_status }}</span>
                                {% elif 'SURPLUS' in ai.ai_status %}
                                    <span class="badge bg-primary px-3 py-2 shadow-sm">{{ ai.ai_status }}</span>
                                {% else %}
                                    <span class="badge bg-success px-3 py-2 shadow-sm">{{ ai.ai_status }}</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="tab-pane fade" id="reports">
             <div class="row">
                <div class="col-md-4 mb-4">
                    <div class="p-4 border border-secondary rounded h-100">
                        <h4 class="text-danger mb-2">ü©∏ Blood Donation Logs</h4>
                        <p style="color: #ddd !important;">Download detailed records.</p>
                        <form action="{{ url_for('export_report') }}" method="GET">
                            <input type="hidden" name="type" value="donations">
                            <label class="form-label mt-2 text-warning">Filter by Blood Group:</label>
                            <select name="blood_group" class="form-select mb-3">
                                <option value="all">All Groups</option>
                                <option value="A+">A+</option><option value="A-">A-</option>
                                <option value="B+">B+</option><option value="B-">B-</option>
                                <option value="O+">O+</option><option value="O-">O-</option>
                                <option value="AB+">AB+</option><option value="AB-">AB-</option>
                            </select>
                            <div class="d-flex gap-2">
                                <button type="submit" name="file_format" value="csv" class="btn btn-danger w-50">CSV</button>
                                <button type="submit" name="file_format" value="pdf" class="btn btn-outline-danger w-50">PDF</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="col-md-4 mb-4">
                    <div class="p-4 border border-secondary rounded h-100">
                        <h4 class="text-info mb-2">üè• Hospital Performance</h4>
                        <p style="color: #ddd !important;">Download summary/detailed.</p>
                        <form action="{{ url_for('export_report') }}" method="GET">
                            <input type="hidden" name="type" value="hospitals">
                            <div class="d-flex gap-2">
                                <button type="submit" name="file_format" value="csv" class="btn btn-info text-white w-50">CSV</button>
                                <button type="submit" name="file_format" value="pdf" class="btn btn-outline-info w-50">PDF</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="col-md-4 mb-4">
                    <div class="p-4 border border-secondary rounded h-100">
                        <h4 class="text-warning mb-2">üèïÔ∏è Camp History Log</h4>
                        <p style="color: #ddd !important;">Download camp logs.</p>
                        <form action="{{ url_for('export_report') }}" method="GET">
                            <input type="hidden" name="type" value="camps_history">
                            <div class="d-flex gap-2">
                                <button type="submit" name="file_format" value="csv" class="btn btn-warning w-50 fw-bold">CSV</button>
                                <button type="submit" name="file_format" value="pdf" class="btn btn-outline-warning w-50 fw-bold">PDF</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="gallery">
            <h4 class="text-info mb-3">üñºÔ∏è Manage Home Page Gallery</h4>
            <div class="row g-3">
                {% for photo in gallery_photos %}
                <div class="col-md-3 col-6">
                    <div class="card bg-dark border-secondary h-100">
                        <img src="{{ url_for('static', filename='uploads/' ~ photo['filename']) }}" class="card-img-top" alt="Camp Photo" style="height: 150px; object-fit: cover;">
                        <div class="card-body p-2">
                            <small class="text-white d-block text-truncate">{{ photo['camp_name'] }}</small>
                            <small class="text-muted">{{ photo['date'] }}</small>
                            <a href="{{ url_for('delete_camp_photo_admin', id=photo['id']) }}" class="btn btn-sm btn-danger w-100 mt-2" onclick="return confirm('Delete this photo?');">Delete</a>
                        </div>
                    </div>
                </div>
                {% else %}
                <p class="text-muted">No photos in the gallery.</p>
                {% endfor %}
            </div>
        </div>

    </div>
</div>

<div class="modal fade" id="adminProfileModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content glass-card border-warning">
            <div class="modal-header border-bottom border-warning">
                <h5 class="modal-title text-warning fw-bold">‚öôÔ∏è Edit Admin Profile</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('update_admin_profile') }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label text-warning">Name</label>
                        <input type="text" name="name" class="form-control" value="{{ admin_info['name'] }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-warning">Email</label>
                        <input type="email" name="email" class="form-control" value="{{ admin_info['email'] }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-warning">Login Phone / ID</label>
                        <input type="text" name="phone" class="form-control" value="{{ admin_info['phone'] }}" required>
                    </div>
                    <hr class="border-secondary">
                    <div class="mb-3">
                        <label class="form-label text-danger fw-bold">‚ö† New Password (Optional)</label>
                        <div class="input-group">
                            <input type="password" name="password" id="adminPass" class="form-control" placeholder="Leave blank to keep current">
                            <button class="btn btn-secondary" type="button" onclick="togglePassword('adminPass', 'adminEye')">
                                <i class="bi bi-eye" id="adminEye"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-top border-warning">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning fw-bold">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="adminAddUnitsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content glass-card border-success">
            <div class="modal-header border-bottom border-success">
                <h5 class="modal-title text-success fw-bold"><i class="bi bi-plus-circle-fill"></i> Add Manual Donation Units</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('admin_add_donation_units') }}" method="POST">
                <div class="modal-body">
                    <p class="text-white mb-3">Adding units for donor: <strong id="add_user_name" class="text-info"></strong></p>
                    <input type="hidden" name="user_id" id="add_user_id">
                    
                    <div class="mb-3">
                        <label class="form-label text-success fw-bold">Hospital Name (to map inventory)</label>
                        <select name="hospital_name" class="form-select border-success" required>
                            {% for h in hospitals %}
                                <option value="{{ h.name }}">{{ h.name }}</option>
                            {% endfor %}
                            <option value="Admin Manual Entry">Admin Manual Entry (No Map Update)</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-success fw-bold">Volume Donated (in ml)</label>
                        <input type="number" name="volume_ml" class="form-control border-success" placeholder="e.g. 450 (1 Unit)" required min="100">
                        <small class="text-muted">Standard 1 unit = 450 ml. This updates the Leaderboard directly.</small>
                    </div>
                </div>
                <div class="modal-footer border-top border-success">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success fw-bold">Save Units</button>
                </div>
            </form>
        </div>
    </div>
</div>
<style>
    @keyframes heartbeat { 0% { transform: scale(1); } 50% { transform: scale(1.1); color: #ffcccc; } 100% { transform: scale(1); } }
    .heartbeat { display: inline-block; animation: heartbeat 1.5s infinite; }
</style>

<script>
    function togglePassword(inputId, iconId) {
        var input = document.getElementById(inputId);
        var icon = document.getElementById(iconId);
        if (input.type === "password") {
            input.type = "text";
            icon.classList.remove("bi-eye");
            icon.classList.add("bi-eye-slash");
        } else {
            input.type = "password";
            icon.classList.remove("bi-eye-slash");
            icon.classList.add("bi-eye");
        }
    }
</script>
{% endblock %}