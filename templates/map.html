{% extends 'layout.html' %}
{% block title %}Find Blood Banks & Camps{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
    /* Modern Map Wrapper */
    .map-wrapper {
        background: #ffffff;
        padding: 15px;
        border-radius: 24px;
        box-shadow: 0 15px 35px rgba(0,0,0,0.08);
        margin-bottom: 2rem;
    }

    /* Container for map relative positioning */
    .map-container {
        position: relative;
        height: 75vh;
        width: 100%;
        border-radius: 16px;
        overflow: hidden;
        border: 2px solid #f0f0f0;
    }

    #map {
        height: 100%;
        width: 100%;
        z-index: 1;
        /* Subtly softens the standard map colors for a more premium look */
        filter: contrast(0.95) saturate(0.8); 
    }

    /* Upgraded Modern "Locate Me" Button */
    .locate-btn {
        position: absolute;
        bottom: 30px;
        right: 30px;
        z-index: 1000;
        background: linear-gradient(135deg, #dc3545 0%, #b02a37 100%);
        border: none;
        border-radius: 50px;
        padding: 12px 24px;
        cursor: pointer;
        font-weight: 800;
        color: white;
        box-shadow: 0 8px 20px rgba(220, 53, 69, 0.4);
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 1rem;
        letter-spacing: 0.5px;
    }
    .locate-btn:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 25px rgba(220, 53, 69, 0.5);
    }
    
    /* Sleek Leaflet Popup Styling Override */
    .leaflet-popup-content-wrapper {
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        padding: 5px;
    }
</style>

<div class="container mt-4">
    <div class="row mb-4 justify-content-center text-center">
        <div class="col-lg-8">
            <span class="badge bg-danger-subtle text-danger rounded-pill px-3 py-2 mb-2 fw-bold">
                <i class="bi bi-radar me-1"></i> LIVE TRACKING
            </span>
            <h2 class="text-dark fw-bolder mb-2" style="font-family: 'Outfit', sans-serif;">Live Blood Inventory Radar</h2>
            <p class="text-muted">Explore active donation camps and real-time hospital blood stock across the region.</p>
        </div>
    </div>

    <div class="map-wrapper">
        <div class="map-container">
            <div id="map"></div>
            <button onclick="locateUser()" class="locate-btn">
                <i class="bi bi-crosshair"></i> Locate Me
            </button>
        </div>
    </div>
</div>

<script>
    // 1. Initialize Map
    var map = L.map('map', { zoomControl: true }).setView([13.0827, 80.2707], 12);

    // 2. Add Standard Fast Tile Layer 
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
    }).addTo(map);

    // 3. Define Icons
    var hospitalIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
    });

    var campIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
    });

    // 4. Fetch Data & Display Popups
    fetch('/api/blood-stock')
        .then(response => response.json())
        .then(data => {
            data.forEach(item => {
                var icon = item.marker_type === 'camp' ? campIcon : hospitalIcon;
                
                // Use the pre-formatted HTML from app.py
                L.marker([item.lat, item.lng], {icon: icon})
                    .bindPopup(item.popup_info) 
                    .addTo(map);
            });
        })
        .catch(err => console.error("Error loading map data:", err));

    // 5. "Locate Me" Functionality
    function locateUser() {
        map.locate({setView: true, maxZoom: 14});
    }

    map.on('locationfound', function(e) {
        var radius = e.accuracy / 2;
        
        // Add a nice blue pulsing circle for the user's location
        L.marker(e.latlng).addTo(map)
            .bindPopup("<b style='color:#007bff;'>You are here</b>").openPopup();
            
        L.circle(e.latlng, {
            radius: radius,
            color: '#007bff',
            fillColor: '#007bff',
            fillOpacity: 0.2
        }).addTo(map);
    });

    map.on('locationerror', function(e) {
        alert("Location access denied or not available. Please check your browser permissions.");
    });
</script>
{% endblock %}